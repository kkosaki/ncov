
custom_rules:
  - japanese_build/subsampling_ranges.smk
  - japanese_build/localrules.smk
 
nextalign_bin: "nextalign"
genes: ["ORF1a", "ORF1b", "S", "ORF3a", "M", "N"]
use_nextalign: true

inputs:
  - name: GISAID-DATA
    metadata: data/gisaid_metadata_latest.tsv.gz
    sequences: data/gisaid_latest.fasta.gz
  - name: Japan-0529
    metadata: data/japan_data0529/metadata3.tsv.xz
    sequences: data/japan_data0529/sequences.fasta.xz

#exclude_ambiguous_dates_by: "day"

builds:
  japan:
    subsampling_scheme: japan
    geographic_scale: country
    region: Asia
    country: Japan
    title: "Phylogenetic analysis of SARS-CoV-2 diversity in Japan"
  501Y-V1:
    subsampling_scheme: pangolin_lineage
    pango_lineage: "B.1.1.7"
    geographic_scale: country
    region: Asia
    country: Japan
    title: "Phylogenetic analysis of SARS-CoV-2 diversity in Japan (Pango lineage:B.1.1.7)"
  501Y-V2:
    subsampling_scheme: pangolin_lineage
    pango_lineage: "B.1.351"
    geographic_scale: country
    region: Asia
    country: Japan
    title: "Phylogenetic analysis of SARS-CoV-2 diversity in Japan (Pango lineage:B.1.351)"
  501Y-V3:
    subsampling_scheme: pangolin_lineage
    pango_lineage: "P.1"
    geographic_scale: country
    region: Asia
    country: Japan
    title: "Phylogenetic analysis of SARS-CoV-2 diversity in Japan (Pango lineage:P.1)"
  Pango-B1617:
    subsampling_scheme: pangolin_sublineage
    pango_lineage: "B.1.617"
    geographic_scale: country
    region: Asia
    country: Japan
    title: "Phylogenetic analysis of SARS-CoV-2 diversity in Japan (Pango lineage:B.1.617.*)"
  Pango-R1:
    subsampling_scheme: pangolin_lineage
    pango_lineage: "R.1"
    geographic_scale: country
    region: Asia
    country: Japan
    title: "Phylogenetic analysis of SARS-CoV-2 diversity in Japan (Pango lineage:R.1)"


inactive_build:
  501Y-V1:
    subsampling_scheme: variants
    clade: "20I/501Y.V1"
    geographic_scale: country
    region: Asia
    country: Japan
    title: "Phylogenetic analysis of SARS-CoV-2 diversity in Japan (20I/501Y.V1)"
  501Y-V2:
    subsampling_scheme: variants
    clade: "20H/501Y.V2"
    geographic_scale: country
    region: Asia
    country: Japan
    title: "Phylogenetic analysis of SARS-CoV-2 diversity in Japan (20H/501Y.V2)"
  501Y-V3:
    subsampling_scheme: variants
    clade: "20J/501Y.V3"
    geographic_scale: country
    region: Asia
    country: Japan
    title: "Phylogenetic analysis of SARS-CoV-2 diversity in Japan (20J/501Y.V3)"
  Pango-R1:
    subsampling_scheme: pangolin_lineage
    pango_lineage: "R.1"
    geographic_scale: country
    region: Asia
    country: Japan
    title: "Phylogenetic analysis of SARS-CoV-2 diversity in Japan (Pango lineage:R.1)"



# trait reconstruction
traits:
  japan:
    sampling_bias_correction: 2.5
    columns: ["country","country_exposure","division","division_exposure"]
  501Y-V1:
    sampling_bias_correction: 2.5
    columns: ["country","country_exposure","division","division_exposure"]
  501Y-V2:
    sampling_bias_correction: 2.5
    columns: ["country","country_exposure","division","division_exposure"]
  501Y-V3:
    sampling_bias_correction: 2.5
    columns: ["country","country_exposure","division","division_exposure"]
  Pango-R1:
    sampling_bias_correction: 2.5
    columns: ["country","country_exposure","division","division_exposure"]
  Pango-B1617:
    sampling_bias_correction: 2.5
    columns: ["country","country_exposure","division","division_exposure"]

# incorporate exposure information
exposure:
  japan:
    trait: "country"
    exposure: "country_exposure"
  501Y-V1:
    trait: "country"
    exposure: "country_exposure"
  501Y-V2:
    trait: "country"
    exposure: "country_exposure"
  501Y-V3:
    trait: "country"
    exposure: "country_exposure"
  Pango-R1:
    trait: "country"
    exposure: "country_exposure"
  Pango-B1617:
    trait: "country"
    exposure: "country_exposure"


files:
  auspice_config: "japanese_build/japan_auspice_config.json"
  colors: "japanese_build/colors.tsv"
  description: "japanese_build/japan_description.md"
  lat_longs: "japanese_build/lat_longs_ja.tsv"
  exclude: "japanese_build/exclude.txt"

subsampling:
  # Default subsampling logic for countries
  japan:
    country_early:
      group_by: "division year month"
      max_sequences: 500
      exclude: "--exclude-where 'country!={country}'"
    country_late:
      group_by: "division year month"
      max_sequences: 3000
      exclude: "--exclude-where 'country!={country}'"
    country_recent:
      group_by: "division year month"
      max_sequences: 3000
      exclude: "--exclude-where 'country!={country}'"
    #JapanQuarantine
    quarantine_early:
      group_by: "division year month"
      max_sequences: 100
      exclude: "--exclude-where 'country!=JapanQuarantine'"
      priorities:
        type: "proximity"
        focus: "country_early"
    quarantine_late:
      group_by: "division year month"
      max_sequences: 200
      exclude: "--exclude-where 'country!=JapanQuarantine'"
      priorities:
        type: "proximity"
        focus: "country_late"
    quarantine_recent:
      group_by: "division year month"
      max_sequences: 200
      exclude: "--exclude-where 'country!=JapanQuarantine'"
      priorities:
        type: "proximity"
        focus: "country_recent"
    # Contextual samples from country's region
    region_early:
      group_by: "country year month"
      max_sequences: 250
      sampling_scheme: "--probabilistic-sampling"
      exclude: "--exclude-where 'country={country}' 'region!={region}'"
      priorities:
        type: "proximity"
        focus: "country_early"
    # Contextual samples from the rest of the world,
    # excluding the current region to avoid resampling.
    global_early:
      group_by: "country year month"
      max_sequences: 300
      sampling_scheme: "--probabilistic-sampling"
      exclude: "--exclude-where 'region={region}'"
      priorities:
        type: "proximity"
        focus: "country_early"
    region_late:
      group_by: "country year month"
      max_sequences: 750
      exclude: "--exclude-where 'country={country}' 'region!={region}'"
      priorities:
        type: "proximity"
        focus: "country_late"
    # Contextual samples from the rest of the world,
    # excluding the current region to avoid resampling.
    global_late:
      group_by: "country year month"
      max_sequences: 500
      exclude: "--exclude-where 'region={region}'"
      priorities:
        type: "proximity"
        focus: "country_late"

  # Default subsampling logic for variants (Clade)
  variants:
    variant:
      group_by: "division year month"
      max_sequences: 6000
      exclude: "--exclude-where 'Nextstrain_clade!={clade}' 'country!={country}'"
      sampling_scheme: "--probabilistic-sampling"
    quarantine:
      group_by: "division year month"
      max_sequences: 1000
      exclude: "--exclude-where 'Nextstrain_clade!={clade}' 'country!=JapanQuarantine'"
      sampling_scheme: "--probabilistic-sampling"
      priorities:
        type: "proximity"
        focus: "variant"
    global:
      group_by: "country year month"
      max_sequences: 2000
      exclude: "--exclude-where 'country={country}' 'Nextstrain_clade!={clade}'"
      sampling_scheme: "--probabilistic-sampling"
      priorities:
        type: "proximity"
        focus: "variant"
  # Subsampling for Pango lineage 
  pangolin_lineage:
    lineage:
      group_by: "division year month"
      max_sequences: 15000
      sampling_scheme: "--probabilistic-sampling"
      exclude: "--exclude-where 'pango_lineage!={pango_lineage}' 'country!={country}'"
    quarantine:
      group_by: "division year month"
      max_sequences: 500
      exclude: "--exclude-where 'Nextstrain_clade!={pango_lineage}' 'country!=JapanQuarantine'"
      sampling_scheme: "--probabilistic-sampling"
      priorities:
        type: "proximity"
        focus: "lineage"
    global:
      group_by: "country year month"
      max_sequences: 3000
      exclude: "--exclude-where 'country={country}' 'pango_lineage!={pango_lineage}'"
      sampling_scheme: "--probabilistic-sampling"
      priorities:
        type: "proximity"
        focus: "lineage"
  # Subsampling for Pango lineage and its sublineages
  pangolin_sublineage:
    lineage:
      group_by: "division year month"
      max_sequences: 3000
      sampling_scheme: "--probabilistic-sampling"
      query: --query "(country=='{country}') & (pango_lineage.str.startswith('{pango_lineage}'))"
    # JapanQuarantine
    quarantine:
      group_by: "division year month"
      max_sequences: 1000
      query: --query "(country=='JapanQuarantine') & (pango_lineage.str.startswith('{pango_lineage}'))"
      sampling_scheme: "--probabilistic-sampling"
      priorities:
        type: "proximity"
        focus: "lineage"
    # Contextual samples from country's region
    global:
      group_by: "country year month"
      max_sequences: 5000
      query: --query "(country!='{country}') & (pango_lineage.str.startswith('{pango_lineage}'))"
      sampling_scheme: "--probabilistic-sampling"
      priorities:
        type: "proximity"
        focus: "lineage"
